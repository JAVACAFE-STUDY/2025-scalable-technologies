# 14. 효율향상 전략

13장에서 처럼 다중화를 진행하면 시스템이 갑자기 다운되더라도 문제 없도록 할 수 있지만
리소 사용률은 떨어진다.
특히 시스템 규모가 작을 수록 다중화에 따른 효율은 떨어진다.

- 서버가 2~3대 밖에 없는데 1~2대를 여유분으로 보유하는 것은 효율이 떨어진다.
  ( 리소스 사용률이 많이 떨어짐 )

→ 즉, 서버를 다중화 할 수록 하드웨어 이용 효율은 떨어진다.

하테나에서는 하드웨어 효율을 위해서 아래와 같은 방법을 사용한다.

- `가상화 기술`을 사용하여 호스트의 집적도를 상승시켜서 전체 리소스 사용률을 올린다.
- 자체제작 서버를 사용해서
  서버 이중화 사양을 가볍게 하여 비용을 낮춘다.

이번장은 이런 효율향상 전략에 대해 알아본다.

# 가상화 기술

## 가상화 기술의 도입

가상화 기술의 목적을 정리하면 다음과 같다.

- 확장성
    - 오버헤드의 최소화
- 비용대비 성능
    - 리소스 사용률 향상
    - 운용의 유연함(환경의 단순화)
- 고가용성
    - 환경의 격리

하테나도 이 부분을 실현하기 위해 가상화 기술을 도입하고 있다.

가상화 기술을 사용할 경우 스토리지로는 네트워크 상의 가상 디스크를 사용하는 구성도 자주 채택되지만,
하테나는 로컬 디스크에 LVM(Logical Volume Manager)의 파티션을 만들고 있다.

## 가상화 기술의 효용

하테나는 가상화 기술을 사용해서 아래와 같은 효용을 얻고 있다.

- IPMI를 대체하는 하이퍼바이저
    - 원래 벤더 서버에는 IPMI(Intelligent Platform Management Interface)라는 리모트 관리 기능이 있는데,  하이퍼바이저를 사용해서 이것을 대체 할 수 있다.

      ![image.png](attachment:6df139ed-c6af-484c-b499-dbfc63e925e9:image.png)

        - 서버 상에 최초로 기동하는 OS = 하이퍼바이저❓
            - 하이퍼바이저 = 단일 하드웨어에서 여러 다른 가상 머신을 호스팅할 수 있는 프로그램이다.
            - 하이퍼바이저는 호스트 하드웨어에서 직접 실행되어 하드웨어를 제어하고 게스트 가상머신을 관리한다.
        - 호스트 OS상에서 기동하는 OS = 게스트OS
    - IPMI는 서버의 전원 On/Off, 상태 확인 등 물리 서버를 네트워크로 관리할 수 있게 하는 하드웨어 수준 인터페이스이다.
    - 하테나는 이를 대체하기 위해 하이퍼바이저 계층을 늘려 게스트 OS를 리모트에서 제어하고 있다.
      (IPMI 탑재X 하드웨어 제어 가능)

  → 기존에는 서버의 물리적 제어(IPMI)를 사용했지만,  이제는 하이퍼바이저를 통해 리모트에서 게스트 OS를 제어할 수 있다.


- 하드웨어 차이를 흡수해서 환경 추상화
    - 새로운 하드웨어나 오래된 하드웨어로도 차분에 신경 쓰지 말고 사용할 수 있다.
      → 즉, 가상화 덕분에 서로 다른 하드웨어 환경에서도 동일한 방식으로 OS를 운영할 수 있다.

- 가상화로 인한 오버헤드를 줄이기 위해 하드웨어를 완전히 에뮬레이팅 하지 않은
  `준 가상화(ParaVirtualization)`라는 방식이 있으며
  하테나에서는 이 방식을 사용하고 있다(Xen 에 특화됨)

- 리소스 소비를 소프트웨어 레벨에서 강력하게 제어할 수 있게 한다
    - 리소스 소비를 제어함으로써 과부하 경고, 부하 조정을 수행한다
    - 비정상적인 리소스 소비를 발견하면 강제적 재시작을 하는데(시스템 안정화 대책) |
      그런 흐름에서 게스트 OS의 자동 재시작도 수행한다
    - 게스트 OS를 자동 재시작할 때에는 monit이라는 리소스 관리용 툴을 이용해 감시한다.
      (감시 값이 임계치를 넘으면 Apache 재시작 or 게스트 OS 재기동)

### ❗ **현재 가상화 기술과 비교**

### 🆚 가상화 기술의 과거 vs 현재

| 관점 | 과거 (책 내용 기준) | 현재 (2020년대) |
| --- | --- | --- |
| 서버 제어 | IPMI, 하이퍼바이저 기반 | IPMI는 여전히 쓰이지만 대부분 **API 기반 원격 관리** (BMC, Redfish 등) |
| 가상화 방식 | Xen 기반 ParaVirtualization | 대부분 **KVM 기반 Full Virtualization** 또는 컨테이너 |
| 리소스 제어 | 게스트 OS 감시 및 재시작 (`monit`) | Kubernetes의 **오토스케일링, 프로브, 리소스 제한** 등 |
| 인프라 운영 | 직접 서버 구축, VM 설치 | **클라우드 인프라 (AWS, GCP, Azure)** 사용 + IaC(Terraform 등) |
| 대체 기술 | 없음 | **컨테이너 기반 (Docker, Kubernetes)** 대세 |

### 💡 정리

- Xen 같은 **준 가상화**는 지금은 많이 쓰이지 않는다. →  요즘은 **KVM** (Linux의 하이퍼바이저)이 기본.
- 많은 서비스가 **컨테이너 기반(Kubernetes)** 으로 넘어감.
- 리소스 소비 감시는 `monit` 대신 Prometheus, Grafana, kube-metrics-server 같은 도구들이 쓰이고, 자동 재시작은 Kubernetes에서 `livenessProbe`나 `readinessProbe`로 처리한다.

## 가상화 서버 구축정책

가상화 도입의 가장 기본적인 목적은 하드웨어 리소스(메모리, CPU, I/O 등)를 최대한 활용하기 위함이다.
이를 위해 아래와 같은 전략을 취한다.

- 하드웨어 이용효율 향상을 위해 남아있는 리소스를 사용하는 게스트 OS를 투입한다.
    - ex) CPU 여유 → 웹 서버 , I/O 여유 → DB 서버,  메모리 여유 → 캐시 서버
- **리소스 경합 회피**
    - 부하가 높고 리소스 소비 경향이 비슷한 게스트 OS끼리는
      리소스를 서로 점유하려고 하므로 같이 두는 것은 피하도록 한다
- 중앙 스토리지는 사용하지 않는다.
    - 가상화 기술을 도입할 때 중앙에 신뢰성이 높은 큰 규모의 스토리지를 두고 네트워크로 파일 시스템을 마운트 하는 구성을 채택할 경우도 있지만,
      고가의 스토리지 서버를 사용하지 않으면 충분한 안정성을 확보할 수 없기 때문에 이런 형태는 사용하지 않았다. → 그런 하드웨어는 비쌈.

## 가상화로 얻은 장점 정리

- 물리적인 리소스 제약에서 해방됨으로써 동적으로 변경할 수 있게 되고 게스트 OS의 마이그레이션이나 복제가 용이해짐 → 서버 증설 용이, 확장성 확보
- 소프트웨어 레벨에서 호스트 리소스를 강력하게 제어할 수 있고,
  비정상 동작 시 문제를 국소화시키고 호스트를 쉽게 제어할 수 있게 되었다.
- 효율이 향상되고 시스템을 전체적으로 안정화할 수 있게 되었다.
- 하드웨어 운용 비용 저하
- 비용 대비 성능향상, 고가용성으로 발전

## 가상화와 운용 **- 서버 관리 툴로 운용측면에서 가상화의 장점을 살리다**

![image.png](attachment:69267dd8-b753-4f1d-ac7e-91b5da68307f:image.png)

서버관리툴에서 서버 간 관계를 파악할 수 있다

이에 대한 관리를 제대로 하지 않으면 운용상 가상화의 장점을 살릴 수 없게 되므로
이와 같은 관리 시스템을 만들어서 함꼐 운용하는 것이 중요하다.

하테나에서는 가상화된 호스트 간 관계를 DNS를 사용해서 조사할 수 있도록 한다.

- DNS를 사용해서 호스트 명으로 IP주소를 얻을 수 있는데,
  더 나아가서 `parent.게스트*OS*호스트명` 명령어로 게스트 OS의 부모 OS의 ip 주소를 얻을 수 있도록 구성한다.

  → 게스트 OS에 이상이 생겨서 외부에서 로그인할 수 없게 된 경우에도
  부모 호스트 OS로 로그인해서 게스트 OS 상태를 확인할 수 있다.


## 가상화 도입 시 주의할 점

- 가상화의 단점 → 성능상 오버헤드가 있다!
    - 하테나를 기준으로 오버헤드의 기준은 아래 같다.
        - CPU 2~3%
        - 메모리 성능에서 1할 정도
        - 네트워크 성능은 절반 정도
        - /O 성능이 5% 정도 떨어진다
- 가상화 기술 구현상 결함으로 인해 갑자기 네트워크가 단절되는 등의 불안정 요인이 늘어나는 경우가 있다.

  → 하지만 이에 비해ㅔ 가상화의 장점이 충분히 커서 가상화를 활용하고 있다고함.

- 네트워크 성능이 반감하는 것은 심각한 문제이다.
    - 하테나는 네트워크 라우터로 PC 라우터를 사용는데,
      PC 라우터에서 가상화를 사용해 성능이 떨어지는 부분이 있었다.

# 하드웨어와 효율 향상

프로세서의 경우 점점 성능이 향상 되고 있고
메모리, HDD의 경우 점점 비용이 저렴해지고 있다.

## 저가 하드웨어의 유용한 이용법 - 가상화를 전제로 한 하드웨어 사용

하테나에서는 저가 하드웨어를 가능한한 유용하게 이용하여고 하는데,
아래와 같이 이용한다.

- 관리기능은 최소한 억제하고 코어는 가능한 많은 것을 채택하며 메모리는 충분히 저렴하므로 상한선까지 탑재한다.
- I/O 성능은 용도별로 요구되는 레벨이 다르기 때문에
    - 디스크가 없는 서버를 준비하거나
    - RAID를 통한 RAID-10을 구성하거나
    - SSD로 RAID-0등을 구성하는 등 다양한 패턴을 갖추고 있다
- IPMI와 같은 관리용 하드웨어는 불필요하다. ( IPMI 기능 추가시 비용 증가 )
    - Intel AMT라는 기능으로 이를 대체하고 가상화 기술로 게스트 OS를 소프트웨어적으로 분리함으로써
      IPMI 없이도 리소스 제어를 가능하게 한다.
