# 12장 - 확장성 확보에 필요한 사고방식

# 31강 - 계층과 확장성

## 확장성에 대한 요구 - 서버 1대에서 처리할 수 있는 트래픽 한계

최근 서비스 중 상당수는 서버 1대로 작동한다. 하테나의 표준적인 사양인 4 core CPU, 8GB 메모리 정도면 피크 시 성능이 수천 요청/분 정도 나온다. 이 정도면 월 100만 page view 정도 처리할 수 있다. 요청이 더 늘어도 DB를 분리하는 정도로 대응할 수 있다. 

4 core CPU 2개, 32GB 메모리의 서버는 수천~1만 건/분, 약 200만 PV/월 정도 처리할 수 있다.

하테나의 경우 한 서비스에 수억 PV/월 정도의 트래픽이 발생한다. 확장이 필요하다.

## 계층별 확장성

AP 서버는 상태를 가지지 않기 때문에 비교적 간단하게 확장할 수 있다. 하지만 DB는 앞서 살펴본대로 확장이 어렵다. 데이터 소스로의 요청은 read, write로 구분할 수 있는데 read 분산은 비교적 쉽지만 write 분산은 매우 어렵다. 

확장 시 AP 서버와 데이터 소스를 구분해서 대응책을 생각하는 것이 중요하다.

# 32강 - 부하 파악, 튜닝

## 부하 파악 - 가시화한 관리화면

확장 방안을 검토하기 위해서는 먼저 서버 **부하**를 파악할 수 있어야 한다. 각 서버 부하를 파악하기 위해서는 서버군을 관리하고 각각의 부하를 적절하게 그래프화하는 것이 중요하다. 

![image.png](12%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9%E1%84%8B%E1%85%A6%20%E1%84%91%E1%85%B5%E1%86%AF%E1%84%8B%E1%85%AD%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%89%E1%85%A1%E1%84%80%E1%85%A9%E1%84%87%E1%85%A1%E1%86%BC%E1%84%89%E1%85%B5%E1%86%A8%201ec431715117808ea0d7d46e63cde722/image.png)

![image.png](12%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9%E1%84%8B%E1%85%A6%20%E1%84%91%E1%85%B5%E1%86%AF%E1%84%8B%E1%85%AD%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%89%E1%85%A1%E1%84%80%E1%85%A9%E1%84%87%E1%85%A1%E1%86%BC%E1%84%89%E1%85%B5%E1%86%A8%201ec431715117808ea0d7d46e63cde722/image%201.png)

하테나에서 자체 개발한 서버관리툴이다.

그림의 1을 보면 서버의 역할이 있다.

## 부하를 측정하기 위한 항목 - Load Average, 메모리 관련, CPU 관련

부하를 볼 때는 먼저 Load Average부터 본다. Load Average는 프로세스가 언제든지 동작할 수 있는 상태지만, 아직 CPU가 할당되지 않아서 대기상태에 있는 프로세스 수의 평균치다. 예를 들어 5분간 LA가 1이라면 평균 1개의 프로세스가 대기상태라는 것이다. 0에 가까울 수록 CPU가 깔끔하게 할당되었다는 뜻이고 CPU 코어 수 이하면 양호한 편이다. 하테나에서는 CPU 코어 수 이하 또는 절반과 같이 용도에 따라 임계값을 조정한다. 용도에 따라서는 코어 수의 몇 배에 달하도록 일부러 제어하기도 한다. (예: Batch 서버. 실시간 응답이 중요하지 않는다.)

사용자 공간이 소비되고 있는 메모리나 공유되고 있는 메모리, 커널이 사용하고 있는 버퍼의 메모리 등 지표도 중요하다.

## 용도에 맞는 튜닝 - 사용자용 서버, 봇용 서버

![image.png](12%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9%E1%84%8B%E1%85%A6%20%E1%84%91%E1%85%B5%E1%86%AF%E1%84%8B%E1%85%AD%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%89%E1%85%A1%E1%84%80%E1%85%A9%E1%84%87%E1%85%A1%E1%86%BC%E1%84%89%E1%85%B5%E1%86%A8%201ec431715117808ea0d7d46e63cde722/image%202.png)

서버 19대의 Load Average가 겹쳐져있다. 1번은 AP 서버의 전체 부하, 2번은 봇용 서버의 부하다.

봇은 응답시간이 중요하지 않아서 요청 처리 수를 최대화하는 방향으로 튜닝했다. LA가 높게 나타난다. 4에서 6라인 정도로 유지되고 있다. 서버의 리소스는 다 소진하고 있다.

사용자용 서버를 보면 사용자의 활동에 따라 부하가 변한다. LA는 1에서 3정도로 낮게 유지된다. 양호한 응답을 위해서 리소스를 남겨두는 방향으로 튜닝한다.

봇과 사용자를 분리해서 응답시간을 최우선으로 할지 리소스를 최대한 사용할지 튜닝 정책을 정할 수 있다.

## AP 서버/DB 서버의 튜닝 정책과 서버 대수

봇용 서버는 리소스를 최대한 사용하는 방향으로 튜닝했기 때문에 서버 대수를 줄일 수 있었다. DB도 마찬가지다.

![image.png](12%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%8C%E1%85%A1%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9%E1%84%8B%E1%85%A6%20%E1%84%91%E1%85%B5%E1%86%AF%E1%84%8B%E1%85%AD%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%89%E1%85%A1%E1%84%80%E1%85%A9%E1%84%87%E1%85%A1%E1%86%BC%E1%84%89%E1%85%B5%E1%86%A8%201ec431715117808ea0d7d46e63cde722/image%203.png)

봇용은 LA를 2정도로, 사용자용은 LA를 1정도로 유지하고 있다. 

## 서비스 규모와 튜닝

서비스 별로 튜닝하고 있다. 하테나 다이어리 서버 대수가 가장 많다. 다이어리는 AP 서버가 종류별로 세분화되어 있다. DB도 북마크보다 더 세분화되어 있다. 

그래프를 겹쳐서 비정상적인 값을 파악하기 쉽게했다.