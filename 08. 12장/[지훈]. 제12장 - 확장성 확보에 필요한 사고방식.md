
# 12. 확장성 확보에 필요한 사고방식

12장은 확장성 확보에 대한 것이다.
서비스 규모가 커짐에 따라  시스템을 얼마나 확장해서 대응할 수 있도록 해둘 것인지에 대해 살펴본다.

# 31. 계층과 확장성

## 확장성에 대한 욕구 - 서버 1대에서 처리할 수 있는 트래픽의 한계

하테나의 표준적인 서버 사양인 4core CPU, 8GB 메모리 서버를 사용하면
피크 시 성능이 수천 요청/분, 100만 PV/월 정도 나온다.
여기에 요청이 좀 더 늘어도 DB를 분리하는 정도로 대응이 가능하다.
따라서 어느정도의 트래픽에서는 서버 한대로도 운영이 가능할 수 있다.

그러나 하테나의 경우 한 서비스에 수억 PV/월 정도의 트래픽이 발생한다.

이정도의 트래픽을 감당하기 위해서는 서버 1대만으로는 불가능하기 때문에
서비스가 커짐에 따라 시스템 구조를 어떻게 확장시켜 나갈지가 중요한 과제가 되었고
여기에는 많은 기술과 노하우가 담겨 있다.

## 계층별 확장성

### AP 서버

- 확장이 간단하다. (로드벨런서를 두고 서버를 추가하기만 하면 됨)
    - 이유 : 상태를 가지고 있지 않기 떄문에 요청별로 다른 AP 서버에서 처리해도 문제가 발생하지 않음

### DB, 파일 서버

- 분산, 확장성 확보가 매우 어렵다.
    - read의 경우 분산이 간단한 반면에,
      write는 분산하기가 어렵다.

# 32. 부하 파악, 튜닝

## 부하 파악 - 가시화한 관리화면

어떻게 확장해갈 것인지를 검토하기 위해서는 먼저 서버 부하를 파악할 수 있어야 한다.
각 서버 부하를 파악하기 위해서는 각각의 부하를 적절하게 그래프화 하는 것이 중요하다.

하테나는 독자적으로 모니터링 툴을 개발해서 사용한다.

## 부하를 측정하기 위한 항목

### Load Average

Linux 커널 내에는 프로세스가 다수 동작하고 있고,
이러한 프로세스가 언제든지 동작할 수 있는 상태이지만
아직 실제 CPU가 할당되지 않아 대기상태에 있는 프로세스 수의 평균치가 Load Average이다.

- ex) 5분간 Load Average = 1 → 5분 동안 평균 1개의 프로세스가 대기 상태로 되어있다는 것
- CPU가 깔끔하게 할당되면 이 값이 0에 가까워지고 CPU 코어 수 이하이면 양호한 편이다

### 부하를 측정하기 위한 항목은 Load Average 이외에도 많이 있는데

메모리 사용처

- 사용자 공간이 소비되고 있는 메모리
- 공유되는 메모리
- 커널이 사용하고 있는 버퍼의 메모리 등이 있다

"이러한 항목을 통해 이런 거동을 하고 있으니 이런 동작을 보이고 있어"와 같이 파악함으로써 서버의 성능을 더 끌어내 고성능 시스템을 실현할 수 있게 되는 것 이라고 한다.

## 용도에 맞는 튜닝

![image.png](attachment:2cf91489-e074-43e1-a78a-548bbcd94401:image.png)

- 책에서 나온 예시의 경우
    - 봇에게 응답하는 것은 응답시간보다 처리량이 중요하므로 처리량에 서버 리소스를 대부분을 쏟고 load average가 평균적으로 높다.
    - 사용자 응답은 응답 시간이 중요하므로 load average를 낮게 유지하고 프로세스를 쌓아두지 않고 잘 응답하는 것을 중요하게 여긴다.
- 어떤 상황에 어떤 튜닝을 하는지가 운영을 할 때 굉장히 중요하다

## **AP 서버/DB 서버의 튜닝 정책과 서버 대수**

용도별로 나눠서 튜닝을 변경함으로써 전체 서버 대수를 줄일 수 있게 된다.
(사용자를 대상으로 한 튜닝인 채로 봇용에 투입해서 동일한 정도의 부하로 처리하려 하면 기존 6대에서 8~9대가 필요하다)

사용자용 DB 또한 전체적으로 부하를 낮게 유지함으로 응답을 빠르게 하는 것을 중요하게 생각한다.
DB도 용도별로 봇용과 사용자용으로 나눠서 응답을 중요시할지, 리소스를 소진하는 것을 중요시 할 지로 나눌수 있다.