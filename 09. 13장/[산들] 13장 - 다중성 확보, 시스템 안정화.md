# 13장 - 다중성 확보, 시스템 안정화

## 다중화와 가동률

> 시스템을 얼마나 멈추지 않도록 할 것인가
> 

가동률 99% 

- 1%의 다운타임 = (86,400초(하루) * 0.01) / 60  = `14분 24초`

가동률에 있어 가장 중요한 것은 장애가 나면 시스템 전체가 멈춰버리는 SPOF(단일장애점)을 제거하는 것이다. 

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%83%E1%85%A1%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9,%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%92%E1%85%AA%201ec431715117801cadfcd06a71925317/image.png)

약간 가동률이 떨어진 부분은 99.98%다. 한 달에 10분 정도 가동이 멈추는 수준이다.

100%에 근접하는 가동률을 실현하기 위해서는 **다중성**이 확보되어야 한다.

# 33강 - 다중성 확보

## 다중성 확보 - AP 서버

AP 서버에서 다중성을 확보하기 위해서는 서버를 여러 개로 늘리는 것이 기본이다. (스케일아웃) 수십 대의 서버가 있을 경우 1,2대가 멈추는 일은 흔하다. 

서버가 멈추는 경우 대응으로 로드밸런서로 failover, failback해서 고장 난 서버를 자동으로 분리하고, 복구되면 원상 복귀시키는 작업을 수행한다. 로드밸런서는 서버에 주기적으로 헬스체크를 한다. 다중화에서 가장 기본적인 부분이다.

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%83%E1%85%A1%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9,%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%92%E1%85%AA%201ec431715117801cadfcd06a71925317/image%201.png)

## 다중성 확보 - DB 서버

DB 서버도 마찬가지로 서버를 여러 대 나열하는 것이 기본이다. Primary(마스터)도 다중화한다.

하테나에서는 멀티 마스터로 마스터를 다중화한다. 멀티 마스터는 쌍방으로 레플리케이션을 해서 어느 쪽에 쓰기를 해도 데이터가 동기화되는 방법이다. 

MySQL은 데이터가 복제되는 지연시간이 있기 때문에 유의해야 한다.

엔터프라이즈에서는 레플리케이션을 동기적으로 처리해서 대처한다. 동기는 확실하게 동기화를 보장할 수 있지만 성능에서 큰 손실이 발생한다.

### 멀티 마스터

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%83%E1%85%A1%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9,%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%92%E1%85%AA%201ec431715117801cadfcd06a71925317/image%202.png)

페일 오버는 DB 서버 상호간 VRRP라는 프로토콜로 감시하고 한 쪽이 분리된 것을 알게 되면 자신이 Active 마스터로 승격된다.

외부에서 어느 쪽 서버가 Active인지 판단하기 위해서는 **Virtual IP**를 사용한다. Active 쪽에 실제 IP 주소와 별도로 서비스용 가상 IP를 부여한다. 예를 들어 두 서버에 0.1, 0.2라는 주소가 부여되여 있는 경우, 새롭게 0.3이라는 가상 IP를 Active 쪽에 할당한다. AP 서버에서는 0.3을 서비스에 사용하고 분리되는 타이밍에 새로운 Active 쪽에 가상 IP 0.3을 재부여한다.

## 다중성 확보 - 스토리지 서버

하테나에서는 이미지 파일과 같은 미디어 파일을 저장하기 위한 분산 스토리지 서버로 MogileFS를 사용하고 있다. 분산 파일 시스템을 사용함으로써 대량의 파일을 보존할 수 있는 확장성과 일부 서버가 다운되더라도 전체 장애가 되지 않도록 다중성을 확보할 수 있다. 

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%83%E1%85%A1%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9,%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%92%E1%85%AA%201ec431715117801cadfcd06a71925317/image%203.png)

MogileFS는 트래커, 스토리지 노드, 메타 정보를 저장하는 트래커 DB라는 세가지 요소로 구성된다. 실제 파일은 스토리지 노드에 위치하며, 특정 URL에 대한 실제 파일의 위치를 나타내는 메타 정보를 DB로 관리한다. 

2번 그림은 용량 그래프다. 

실제로 사용하는 스토리지 서버 사양은 자체제작 서버에 보통 1TB 3.5인치 HDD를 4개 탑재해서 4TB다. 스토리지 노드를 10대 정도 사용해서 18TB 구성했다. 한 대당 용량을 너무 늘리면 저장된 파일 수가 너무 많아져서 읽기나 쓰기 I/O 성능이 병목되어 100% 용량을 다 사용할 수 없는 경우도 있다.

# 34강 - 시스템 안정화

## 시스템 안정화를 위한 상반관계

시스템을 안정화하다보면 **자원효율**, **속도**에서 잃는 것이 있다. 서버의 자원인 메모리, CPU를 최대로 사용하면 좋겠지만 안정성을 위해서는 메모리와 CPU를 7할 정도만 사용하는 것이 좋다. 

자원을 한계까지 사용하는 경우에는 사용량이 올라면 메모리는 스왑 때문에 성능 저하 및 장애가 발생할 수 있고, CPU는 처리능력이 부족해지면서 속도가 저하된다. 자원을 여유있게 사용하면 새로운 서버를 추가할 시간을 확보할 수 있어서 안정성이 높아진다.

## 시스템의 불안정 요인

시스템의 불안정 요인은 시스템 구성이 복잡해질 수록 늘어난다.

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20-%20%E1%84%83%E1%85%A1%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%AA%E1%86%A8%E1%84%87%E1%85%A9,%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%92%E1%85%AA%201ec431715117801cadfcd06a71925317/image%204.png)

### 1. 기능 추가, 2. 메모리 누수

새로운 기능을 추가하면 기능이 예상보다 무거워서 부하가 늘어나는 경우가 있다.

### 3. 지뢰

아무리 시간이 지나도 응답이 오지 않아서 마치 지뢰처럼 장애의 원인이 되는 현상이다. 주로 메모리 누수나 무한루프 때문에 발생한다. (테스트를 잘 해야할듯..) 지뢰를 다소 밟더라도 문제가 되지 않도록 설계하는 것이 중요하다.

### 4. 사용자의 액세스 패턴

당연한 이야기지만 갑자기 요청이 늘어나면 부하가 증가한다. 

엑세스 변동을 흡수할 수 있도록 시스템을 구성하는 것이 중요하다. 캐싱를 사용하면 리소스를 거의 사용하지 않기 때문에 잘 사용하는 것이 중요하다. 

### 5. 데이터량 증가

데이터가 크게 증가하는 경우 DB 크기가 커지면서 조회 시 메모리가 부족해서 장애가 나는 경우가 있다.

사용자 엑세스가 크게 늘어도 데이터량이 선형적으로 증가하지 않는 구조로 설계하는 것도 중요하다. 예를 들어 좋아요하나 당 레코드가 하나 쌓이는 식을 레코드 하나에 좋아요 정보를 전부 저장하는 식으로 설계한다.

### 6. 외부연계 추가

외부 시스템이 장애가 나는 경우 덩달아서 장애가 생길 수 있다. 외부 시스템이 다운되어도 그 부분은 무시하고 동작하게하는 것이 중요하다.

### 7. 메모리, HDD 장애, 8. NIC 장애

하드웨어나 네트워크 장애는 일상적으로 발생한다. 하드웨어 능력이 저하되더라도 문제가 되지 않도록 해두는 것도 중요하다. 예를 들면 로드밸런서에서 적정한 항목에 대해 헬스체크 해서 하드웨어 장애로 이상이 생겼을 때 바로 문제가 발생한 서버로 요청을 차단한다. 

# 35강 - 시스템 안정화 대책

## 실제 안정화 대책 - 적절한 버퍼 유지와 불안정 요인 제거

안정화를 위한 실제 대책

- **적절한 버퍼 유지**
- **불안정 요인 제거**

적절한 버퍼 유지

- 시스템 수용 능력의 70%를 상한선으로 설정. 상한을 넘는 경우 서버나 메모리 추가.

불안정 요인 제거

- SQL 부하대책
- 메모리 누수 줄이기
- 비정상 동식 시 자율제어

- SQL 부하
    - 사용자가 사용하는 DB와 격리된 DB를 두고 높은 부하의 SQL은 격리된 DB에 날림으로 사용자 DB의 부하를 줄인다.

### 이상 동작 시의 자율제어

1. 자동 Dos 판정
2. 자동 재시작
3. 자동 쿼리제거
- 자동 Dos 판정
    
    1시간에 특정 IP주소로 다수의 요청이 오면 일정 시간 403을 반환해서 엑세스를 차단.
    
- 자동 재시작
    
    리소스를 지나치게 사용하는 경우 서버를 재시작한다. 다이어리에는 코드양도 많고 버그, 메모리 누수도 있기 때문에 가끔씩 재시작한다.
    
- 자동 쿼리제거
    
    10초에 한 번 씩 서버에서 실행되고 있는 쿼리를 파악해서 일정 시간이 경과한 쿼리를 강제로 KILL한다. 쿼리 시간이 너무 길어지면 DB가 멈출 수 있기 때문이다. 
    

자율제어가 너무 잘 작동하면 문제를 덮어두는 꼴이 될 수 있기 때문에 개발할 때 본질적으로 문제없도록 개발하는 것이 중요하다.