
# 15. 웹 서비스와 네트워크

서비스의 네트워크 트래픽이 많지 않다면
각 서버를 아무 생각 없이 스위치에 연결하고 라우터 하나만 준비해도 된다.

하지만 트래픽이 늘어나면서 그 이상의 스펙이 필요해지는 상황이 발생한다.
책에서는 아래 케이스를 소개한다.

- 트래픽이 Gbit 단위, 1Gbps가 되면 여러 문제들이 발생
- 호스트수가 500을 넘어갈 때 하나의 서브넷으로 구성하게 되면 패킷 손실 등의 문제들이 발생
- 글로벌 서비스를 준비할 때 데이터 센터를 한 곳에서만 운영하면
  태평양이나 대서양을 지나는 장거리 트래픽이 발생해 latency도 한계에 이르게 된다.

이번 장에서는 이에 대한 대책들, 분기점들에 대해 설명한다.

# 네트워크 분기점

## 서비스 성장과 네트워크 분기점

서비스가 성장해감에 따라 서버를 넘어서 네트워크에도 트래픽의 한계가 보이기 시작한다.
이에 따라서 네트워크의 분기점을 알아둬야한다.

이 책에서 소개하는 분기점은 아래와 같다.

- 1Gbps(라우터 성능 관점에서 사실은 30만pps) 이상
  → PC 라우터의 한계
- 500 호스트 이상 → 1 서브넷의 한계
- 글로벌화 → 1 데이터 센터의 한계

## 1Gbps의 한계 - PC 라우터의 한계

- 1Gbps의 한계는 정확히 30만pps가 한계이다.
- 해결책
    - PC 라우터를 여러 대 병렬화
    - 고가의 박스형 라우터를 구입

하테나에서는 “라우터를 여러 대 병렬화” 하고 있다.

## 500 호스트의 한계

스위치의 ARP(Address Resolution Protocol)테이블과 관련해서 한계가 있다

- 스위치 내에서 ARP 테이블의 크기는 수백건 정도 된다
    - ARP 테이블의 상한선이 900건 이었는데,
      내용이 800건 이상 늘어나자 특정 호스트로 ping이 가지 않는 문제가 생겼다.

  → 원인은 ARP 테이블의 한계였고,
  1서브넷은 500호스트가 한계라는 것을 기억해두면 좋다.

- 또한 서브넷 내에 호스트를 많이 두면 브로드캐스팅 패킷이 서서히 증가하고
  이를 수신하는 것만 해도 CPU를 잡아먹게 된다.
    - 특히 브로드캐스팅 통신에 의존한 처리가 많아지면
      Ethernet을 연결 하는 것만으로 CPU 부하가 수십%까지 올라가기도 한다.

→ 따라서!  1서브넷 내의 서버 대수는 500대 이하로 억제하는 것이 현명하다.

### 

## 네트워크 구조 계층화

지금까지 언급한 네트워크 문제는 `네트워크 구조의 계층화` 라는 것이 최선의 해결책이라고 한다.

보통 3단계로 이루어진다.

- 가장 작은 것은 Access 계층(액세스 영역)
- 그 다음이 Distribution 계층(디스트리뷰션 영역)
- 가장 위가 Core 계층(코어 영역) 또는 OSPF(Open Shortest Path First) 영역

![image.png](attachment:a6c2f2d1-a638-4b0f-aa42-b37b9e0b7c79:image.png)

가장 작은 서브넷에서 100,200대로 억제하고,  디스트리뷰션을 1000대 정도,
코어 전체로는 10000대 단위를 다룰 수 있는 계층 구조를 설계하는 것이 일반적이다.

## 글로벌화

서비스가 글로벌화 됨에 따라 태평양을 넘는 액세스는 상당히 오버헤드이다.

→ CDN을 사용하면 타임아웃이 거의 발생하지 않고 양호한 응답 시간을 유지할 수 있다.

### CDN(Content Delivery Network)이란?

세계 각지에 서버를 두고 거기에 미디어를 캐싱시켜 사용자가 가지러 갈 때
가장 가까운 서버로 액세스해서 미디어를 다운로드하도록 한다.

# 한층 높은 단계로

## 10Gbps 이상의 세계

인터넷 인프라가 극한 성능(초고속 트래픽)을 다루게 될 때의 이야기로

- AS 번호(Antonomous System Number)라는 것을 보유하고
- IX(Internet Exchange)에 접속해서 트래픽을 교환하거나
- BGP(Boarder Gateway Protocol)이라는 인터넷의 라우팅을 제어하는 프로토콜을 사용한다.

잘못 제어를 하면 다른 사이트에도 영향을 미치게 된다.

- ex) 특정 조직이 BGP를 통해 잘못된 라우팅 정보를 흘려보내서 이 사이트의 트래픽 제어를 제대로 할 수 없어 결과적으로 그 지역에서 볼 수 없게 되는 경우가 있다.

## 하테나의 인프라

하테나의 인프라를 정리하자면 다음 요소가 핵심이다.

- 저비용, 높은 확장성
- 적당하면서 충분히 높은 신뢰성

그 기술로는 아래 네가지를 소개했다.

- 확장성
- 다중화
- 효율 향상
- 네트워크